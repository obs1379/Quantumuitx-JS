/**********************************************
 * Quantumult X ä¸“ç”¨èŠ‚ç‚¹é£é™©æ£€æµ‹/åœ°ç†ä¿¡æ¯è„šæœ¬
 * åŸä½œè€…: https://github.com/shuijiao1/Fly
 * æ”¹åŠ¨: ç§»é™¤ $httpClientï¼Œæ”¹ç”¨ $task.fetch
 **********************************************/

// åŸºç¡€é…ç½®
let base_url = "https://scamalytics.com/ip/";

// IPåœ°ç†ä¿¡æ¯API
var url = "http://ip-api.com/json/";

// ä» QX ç¯å¢ƒä¸­è·å–è„šæœ¬å‚æ•°ï¼ˆå¦‚èŠ‚ç‚¹åï¼‰
var inputParams = $environment.params;
var nodeName = inputParams.node || "å½“å‰èŠ‚ç‚¹";

// å°è£… GET è¯·æ±‚å‡½æ•°ï¼Œå…¼å®¹ Quantumult X
function httpGet(options, callback) {
  let reqUrl = options.url;
  // ä»…ä½¿ç”¨ url å‘èµ·è¯·æ±‚ï¼Œè‹¥éœ€ headers ç­‰ï¼Œå¯è‡ªè¡Œæ‰©å±•
  $task.fetch({
    url: reqUrl,
    method: "GET"
  }).then(
    (response) => {
      // åœ¨ QX ä¸­ï¼Œresponse.body æ‰æ˜¯è¿”å›çš„ä¸»ä½“
      callback(null, response, response.body);
    },
    (reason) => {
      callback(reason.error, null, null);
    }
  );
}

// å…ˆæŸ¥ IP åœ°ç†ä¿¡æ¯
var requestParams = {
  url: url
};

httpGet(requestParams, (error, response, data) => {
  if (error) {
    let message = "</br></br>ğŸ”´ æŸ¥è¯¢è¶…æ—¶";
    message = wrapMessage(message);
    $done({
      title: "åœ°ç†ä½ç½®æŸ¥è¯¢",
      htmlMessage: message
    });
  } else {
    // è§£æå¹¶å¤„ç†åœ°ç†ä¿¡æ¯
    let message = data ? json2info(data) : "";
    let ip = JSON.parse(data).query;

    // å†æŸ¥æ¬ºè¯ˆæŒ‡æ•°
    var scamRequestParams = {
      url: base_url + ip
    };
    httpGet(scamRequestParams, (error2, response2, scamData) => {
      if (error2) {
        message = "</br></br>ğŸ”´ æŸ¥è¯¢è¶…æ—¶";
        message = wrapMessage(message);
        $done({
          title: "åœ°ç†ä½ç½®æŸ¥è¯¢",
          htmlMessage: message
        });
      } else {
        // ç»„åˆæœ€ç»ˆä¿¡æ¯
        message = message + Display(scamData);
        message =
          message +
          "------------------------------" +
          "</br>" +
          "<font color=#6959CD><b>èŠ‚ç‚¹</b> âŸ " +
          nodeName +
          "</font>";

        message = `<p style="text-align: center; font-family: -apple-system; font-size: large; font-weight: thin">` + message + `</p>`;
        $done({
          title: "åœ°ç†ä½ç½®æŸ¥è¯¢",
          htmlMessage: message
        });
      }
    });
  }
});

// ç¾åŒ–æŠ¥é”™ä¿¡æ¯
function wrapMessage(msg) {
  return `<p style="text-align: center; font-family: -apple-system; font-size: large; font-weight: bold;">${msg}</p>`;
}

// è§£æ ip-api è¿”å›çš„ JSON
const paras = ["query", "as", "org", "isp", "countryCode", "city", "lon", "lat"];
const paran = [
  "è¿œç«¯IPåœ°å€",
  "è¿œç«¯IP ASN",
  "ASNæ‰€å±æœºæ„",
  "è¿œç«¯ISP",
  "è¿œç«¯IPåœ°åŒº",
  "è¿œç«¯IPåŸå¸‚",
  "è¿œç«¯ç»åº¦",
  "è¿œç«¯çº¬åº¦"
];

function json2info(cnt) {
  let res = "-------------------------------";
  let obj = JSON.parse(cnt);

  for (let i = 0; i < paras.length; i++) {
    // å¦‚æœæ˜¯ countryCodeï¼Œå°±å¸¦ä¸Šå›½æ——
    if (paras[i] === "countryCode") {
      let cc = obj[paras[i]].toUpperCase();
      obj[paras[i]] = obj[paras[i]] + " âŸ¦" + (flags.get(cc) || "") + "âŸ§";
    }
    // æ‹¼æ¥ä¿¡æ¯
    if (obj[paras[i]]) {
      res += `</br><b><font color="">${paran[i]}</font> : </b><font color="">${obj[paras[i]]}</font></br>`;
    }
  }
  return res;
}

// è§£æ scamalytics.com é¡µé¢å†…å®¹ï¼Œæå–æ¬ºè¯ˆæŒ‡æ•°å’Œé£é™©ç­‰çº§
function Display(cnt) {
  let score = cnt.indexOf(`"score":`) !== -1
    ? cnt.split(`"score":`)[1].split("\n")[0]
    : "NA";
  score = score.replace(/"|,/g, "");
  score = `</br><b><font color="">æ¬ºè¯ˆæŒ‡æ•° </font> : </b><font color="">${score}</font></br>`;

  let risk = cnt.indexOf(`"risk":`) !== -1
    ? cnt.split(`"risk":`)[1].split("\n")[0]
    : "NA";
  risk = risk.replace(/"|,/g, "");
  risk = `</br><b><font color="">é£é™©ç­‰çº§ </font> : </b><font color="">${E2C(risk)}</font></br>`;

  return score + risk;
}

// æŠŠè‹±æ–‡é£é™©ç­‰çº§è½¬æˆä¸­æ–‡+å›¾æ ‡
function E2C(cnt) {
  let res = "NA";
  if (cnt.indexOf("very high") !== -1) {
    res = "æé«˜é£é™© ğŸ”´";
  } else if (cnt.indexOf("high") !== -1) {
    res = "é«˜é£é™© âš ï¸";
  } else if (cnt.indexOf("medium") !== -1) {
    res = "ä¸­é£é™© ğŸŸ¡";
  } else if (cnt.indexOf("low") !== -1) {
    res = "ä½é£é™© âœ…";
  }
  return res;
}

// å¸¸ç”¨å›½æ——æ˜ å°„è¡¨
var flags = new Map([
  ["AC","ğŸ‡¦ğŸ‡¨"],["AE","ğŸ‡¦ğŸ‡ª"],["AF","ğŸ‡¦ğŸ‡«"],["AI","ğŸ‡¦ğŸ‡®"],["AL","ğŸ‡¦ğŸ‡±"],
  ["AM","ğŸ‡¦ğŸ‡²"],["AQ","ğŸ‡¦ğŸ‡¶"],["AR","ğŸ‡¦ğŸ‡·"],["AS","ğŸ‡¦ğŸ‡¸"],["AT","ğŸ‡¦ğŸ‡¹"],
  ["AU","ğŸ‡¦ğŸ‡º"],["AW","ğŸ‡¦ğŸ‡¼"],["AX","ğŸ‡¦ğŸ‡½"],["AZ","ğŸ‡¦ğŸ‡¿"],["BA","ğŸ‡§ğŸ‡¦"],
  ["BB","ğŸ‡§ğŸ‡§"],["BD","ğŸ‡§ğŸ‡©"],["BE","ğŸ‡§ğŸ‡ª"],["BF","ğŸ‡§ğŸ‡«"],["BG","ğŸ‡§ğŸ‡¬"],
  ["BH","ğŸ‡§ğŸ‡­"],["BI","ğŸ‡§ğŸ‡®"],["BJ","ğŸ‡§ğŸ‡¯"],["BM","ğŸ‡§ğŸ‡²"],["BN","ğŸ‡§ğŸ‡³"],
  ["BO","ğŸ‡§ğŸ‡´"],["BR","ğŸ‡§ğŸ‡·"],["BS","ğŸ‡§ğŸ‡¸"],["BT","ğŸ‡§ğŸ‡¹"],["BV","ğŸ‡§ğŸ‡»"],
  ["BW","ğŸ‡§ğŸ‡¼"],["BY","ğŸ‡§ğŸ‡¾"],["BZ","ğŸ‡§ğŸ‡¿"],["CA","ğŸ‡¨ğŸ‡¦"],["CF","ğŸ‡¨ğŸ‡«"],
  ["CH","ğŸ‡¨ğŸ‡­"],["CK","ğŸ‡¨ğŸ‡°"],["CL","ğŸ‡¨ğŸ‡±"],["CM","ğŸ‡¨ğŸ‡²"],["CN","ğŸ‡¨ğŸ‡³"],
  ["CO","ğŸ‡¨ğŸ‡´"],["CP","ğŸ‡¨ğŸ‡µ"],["CR","ğŸ‡¨ğŸ‡·"],["CU","ğŸ‡¨ğŸ‡º"],["CV","ğŸ‡¨ğŸ‡»"],
  ["CW","ğŸ‡¨ğŸ‡¼"],["CX","ğŸ‡¨ğŸ‡½"],["CY","ğŸ‡¨ğŸ‡¾"],["CZ","ğŸ‡¨ğŸ‡¿"],["DE","ğŸ‡©ğŸ‡ª"],
  ["DG","ğŸ‡©ğŸ‡¬"],["DJ","ğŸ‡©ğŸ‡¯"],["DK","ğŸ‡©ğŸ‡°"],["DM","ğŸ‡©ğŸ‡²"],["DO","ğŸ‡©ğŸ‡´"],
  ["DZ","ğŸ‡©ğŸ‡¿"],["EA","ğŸ‡ªğŸ‡¦"],["EC","ğŸ‡ªğŸ‡¨"],["EE","ğŸ‡ªğŸ‡ª"],["EG","ğŸ‡ªğŸ‡¬"],
  ["EH","ğŸ‡ªğŸ‡­"],["ER","ğŸ‡ªğŸ‡·"],["ES","ğŸ‡ªğŸ‡¸"],["ET","ğŸ‡ªğŸ‡¹"],["EU","ğŸ‡ªğŸ‡º"],
  ["FI","ğŸ‡«ğŸ‡®"],["FJ","ğŸ‡«ğŸ‡¯"],["FK","ğŸ‡«ğŸ‡°"],["FM","ğŸ‡«ğŸ‡²"],["FO","ğŸ‡«ğŸ‡´"],
  ["FR","ğŸ‡«ğŸ‡·"],["GA","ğŸ‡¬ğŸ‡¦"],["GB","ğŸ‡¬ğŸ‡§"],["HK","ğŸ‡­ğŸ‡°"],["HU","ğŸ‡­ğŸ‡º"],
  ["ID","ğŸ‡®ğŸ‡©"],["IE","ğŸ‡®ğŸ‡ª"],["IL","ğŸ‡®ğŸ‡±"],["IM","ğŸ‡®ğŸ‡²"],["IN","ğŸ‡®ğŸ‡³"],
  ["IS","ğŸ‡®ğŸ‡¸"],["IT","ğŸ‡®ğŸ‡¹"],["JP","ğŸ‡¯ğŸ‡µ"],["KR","ğŸ‡°ğŸ‡·"],["LU","ğŸ‡±ğŸ‡º"],
  ["MO","ğŸ‡²ğŸ‡´"],["MX","ğŸ‡²ğŸ‡½"],["MY","ğŸ‡²ğŸ‡¾"],["NL","ğŸ‡³ğŸ‡±"],["PH","ğŸ‡µğŸ‡­"],
  ["RO","ğŸ‡·ğŸ‡´"],["RS","ğŸ‡·ğŸ‡¸"],["RU","ğŸ‡·ğŸ‡º"],["RW","ğŸ‡·ğŸ‡¼"],["SA","ğŸ‡¸ğŸ‡¦"],
  ["SB","ğŸ‡¸ğŸ‡§"],["SC","ğŸ‡¸ğŸ‡¨"],["SD","ğŸ‡¸ğŸ‡©"],["SE","ğŸ‡¸ğŸ‡ª"],["SG","ğŸ‡¸ğŸ‡¬"],
  ["TH","ğŸ‡¹ğŸ‡­"],["TN","ğŸ‡¹ğŸ‡³"],["TO","ğŸ‡¹ğŸ‡´"],["TR","ğŸ‡¹ğŸ‡·"],["TV","ğŸ‡¹ğŸ‡»"],
  ["TW","ğŸ‡¨ğŸ‡³"],["UK","ğŸ‡¬ğŸ‡§"],["UM","ğŸ‡ºğŸ‡²"],["US","ğŸ‡ºğŸ‡¸"],["UY","ğŸ‡ºğŸ‡¾"],
  ["UZ","ğŸ‡ºğŸ‡¿"],["VA","ğŸ‡»ğŸ‡¦"],["VE","ğŸ‡»ğŸ‡ª"],["VG","ğŸ‡»ğŸ‡¬"],["VI","ğŸ‡»ğŸ‡®"],
  ["VN","ğŸ‡»ğŸ‡³"],["ZA","ğŸ‡¿ğŸ‡¦"]
]);
